################################################################################
# Agazella.modelling.Ker project
# Lola Gilbert lola.gilbert@univ-lr.fr
#
# March 2025
# 04.relative-enrichment-thought-experiment.R
#
################################################################################

# To get a quantitative idea of the relative enrichment 
# in nutrients mediated by fur seals, we compare the Fe input 
# from one hypothetical fur seal scat and the iron pool in the 
# mixed layer, or the Fe regenerated by zooplankton in the mld

# Oceanographic data is from Bowie et al 2015, Iron budgets for three distinct 
# biogeochemical sites around the Kerguelen Archipelago (Southern Ocean) 
# during the natural fertilisation study, KEOPS-2
# in Biogeosciences

#'
#'
#'
#'
#' generate the data on oceanographic conditions at two study stations 
#' (one on Kerguelen Central Plateau and one in an offshore plume east of 
#' Kerguelen) which match relatively well with foraging areas of fur seals 
#' from the two studied colonies (Cap Noir for the offshore plume and 
#' Pointe Suzanne for the Central Plateau)
bowieetal2015_data <- function() {
  # mld, dFe_micromol_perm2, pFe_micromol_perm2 are from Table 1
  # only means are reported for dfe and pFe
  # Fe_mld_regeneration_nmol_perm2_perday is from Table 3
  # bacterial and mesozooplankton regeneration rates
  
  bowie_raw_data <- tibble::tribble(
    ~station, ~substation, ~mld_m, ~dFe_micromol_perm2, ~pFe_micromol_perm2, ~Fe_mld_regeneration_nmol_perm2_perday,
    "Plateau", "A3-1", 165, 54, 1392, 19,
    "Plateau", "A3-2", 123, 21, 401, 71,
    "Plume", "E-1", 64, NA, 117, 27,
    "Plume", "E-3", 32, 12, NA, 23,
    "Plume", "E-5", 39, 2, 61, 31)
  
}


#'
#'
#'
# we need one value per station, so we average data from the substations, per 
# station
wrangling_bowieetal2015_data <- function(bowie_raw) {
  bowie_avg <- bowie_raw |>
    dplyr::group_by(station) |>
    dplyr::summarise(mld_m_avg = mean(mld_m), 
                     dFe_micromol_perm2_avg = mean(dFe_micromol_perm2, 
                                                   na.rm = TRUE),
                     pFe_micromol_perm2_avg = mean(pFe_micromol_perm2, 
                                                   na.rm = TRUE),
                     Fe_mld_regeneration_nmol_perm2_perday_avg = mean(Fe_mld_regeneration_nmol_perm2_perday, 
                                                   na.rm = TRUE))
  
  # for Fe_mld_regeneration rates we want the data in micromole
  # and for all we want also results in m3 (assuming an even distribution across
  # the mld, very simplistically)
  # we also want tFe = dFe +pFe
  
  bowie_complete_clean <- bowie_avg |>
    dplyr::mutate(tFe_micromol_perm2_avg = dFe_micromol_perm2_avg +
                    pFe_micromol_perm2_avg, 
                  dFe_micromol_perm3_avg = dFe_micromol_perm2_avg/mld_m_avg,
                  pFe_micromol_perm3_avg = pFe_micromol_perm2_avg/mld_m_avg, 
                  tFe_micromol_perm3_avg = dFe_micromol_perm3_avg +
                    pFe_micromol_perm3_avg, 
                  Fe_mld_regeneration_micromol_perm2_perday_avg = Fe_mld_regeneration_nmol_perm2_perday_avg*1e-3, 
                  Fe_mld_regeneration_micromol_perm3_perday_avg = Fe_mld_regeneration_micromol_perm2_perday_avg/mld_m_avg) |>
    dplyr::select(station, mld_m_avg,
                  tFe_micromol_perm2_avg, 
                  tFe_micromol_perm3_avg, 
                  Fe_mld_regeneration_micromol_perm2_perday_avg, 
                  Fe_mld_regeneration_micromol_perm3_perday_avg)
  
}


#'
#'
#'
# build up hypothetical scats data
hypo_scats <- function(scat_data,
                       scat_compo_tib) {

  # scats paired by code samples to match dry weights and 
  # Fe concentrations
  scats_paired <- scat_compo_tib |>
    dplyr::select(Code_sample, Fe) |>
    dplyr::left_join(scat_data |>
                       dplyr::select(Code_sample, 
                                     ww, dw), 
                     by = "Code_sample")
  
  # we make the calculations for 3 hypothetical scat: 
  # - one that has low concentrations in Fe, for this one we 
  # filter samples that have Fe concentrations 
  # below the 5 percentile, and we average their concentrations and
  # their dry weight
  # - one with a Fe concentration corresponding to the median value, 
  # we also take the median weigth for this one
  # - one that has high concentrations in Fe, filtering samples that
  # have Fe concentrations above the 95 percentile, and averaging 
  # concentrations and dry weight
  scat_below_5p <- scats_paired |>
    dplyr::filter(Fe <= quantile(Fe, 0.05)) |>
    dplyr::summarise(Fe_mg_kg_avg = mean(Fe), 
                     dw_g_avg = mean(dw)) |>
    dplyr::mutate(scat_type = "below_5p", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
  
  scat_median <- scats_paired |>
    dplyr::summarise(Fe_mg_kg_avg = median(Fe), 
                     dw_g_avg = median(dw)) |>
    dplyr::mutate(scat_type = "median", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
                    
  scat_above_95p <- scats_paired |>
    dplyr::filter(Fe >= quantile(Fe, 0.95)) |>
    dplyr::summarise(Fe_mg_kg_avg = mean(Fe), 
                     dw_g_avg = mean(dw)) |>
    dplyr::mutate(scat_type = "above_95p", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
    
  # hypo_scat_data 
  hypo_scat_data <- scat_below_5p |>
    dplyr::bind_rows(scat_median, 
                     scat_above_95p) |>
    dplyr::mutate(station = "Plateau") |>
    dplyr::bind_rows(scat_below_5p |>
                       dplyr::mutate(station = "Plume"),
                     scat_median |>
                       dplyr::mutate(station = "Plume"), 
                     scat_above_95p|>
                       dplyr::mutate(station = "Plume")) |>
    dplyr::select(station, scat_type, 
                  dw_g_avg, Fe_mg_kg_avg, 
                  Fe_mg, Fe_micromol)
}

#'
#'
#'
#'
# compute relative enrichment %
relative_enrichment <- function(bowie_clean_data, 
                                hypo_scat_data) {

  rel_enrichment_p <- bowie_clean_data |>
    dplyr::left_join(hypo_scat_data, 
                     by = "station") |>
    dplyr::mutate(rel_Fe_enrichment_perm2 = 100*(Fe_micromol/tFe_micromol_perm2_avg), 
                  rel_Fe_enrichment_perm3 = 100*(Fe_micromol/tFe_micromol_perm3_avg), 
                  rel_Fe_enrichment_perm2_5p = 100*(0.05*Fe_micromol/tFe_micromol_perm2_avg), 
                  rel_Fe_enrichment_perm3_5p = 100*(0.05*Fe_micromol/tFe_micromol_perm3_avg))
  
  openxlsx::write.xlsx(rel_enrichment_p, 
                       file = paste0("output/table_Fe_rel_enrichment_around_Ker.xlsx"))
}




##### previous version ####

#'
#'
#'
#'
# estimate relative enrichment provoked by one scat released at the top of the 
# mixed water layer around Kerguelen, with values of Fe concentrations from 
# Bowie et al. 2015
table_nut_enrichment_at_sea <- function(scat_data, 
                                        scat_compo_tib) {
  
  # calculate Fe content (in micromole) in one average scat, scat with low 
  # Fe concentration, and high Fe concentration 
  median_Fe <- median((scat_compo_tib |>
                         dplyr::filter(Code_sample != "CN12"))$Fe)
  median_dw <- median((scat_data |>
                         dplyr::filter(Code_sample != "CN12"))$dw)
  
  # for low concentration factice sample, we use the mean of the samples with Fe 
  # concentration below or equal to 5% quantile value with the mean of the dw of
  # these same samples
  ID_samples_below5p <- (scat_compo_tib |> 
                           dplyr::select(Code_sample, Fe) |>
                           dplyr::filter(Fe <= quantile(Fe, 0.05)))$Code_sample
  ID_samples_above95p <- (scat_compo_tib |> 
                            dplyr::select(Code_sample, Fe) |>
                            dplyr::filter(Fe >= quantile(Fe, 0.95)))$Code_sample
  
  below5p_avrg_dw <- mean((scat_data |>
                             dplyr::filter(Code_sample %in% ID_samples_below5p))$dw)
  above95p_avrg_dw <- mean((scat_data |>
                              dplyr::filter(Code_sample %in% ID_samples_above95p))$dw)
  
  scat_Fe_content <- rbind(
    # saverage scat with Fe content <= 5% of Fe concentration
    scat_compo_tib |> 
      dplyr::select(Code_sample, Fe) |>
      dplyr::filter(Fe <= quantile(Fe, 0.05)) |>
      dplyr::summarise(Fe = mean(Fe)) |>
      dplyr::mutate(Code_sample = "lowFe_scat") |>
      dplyr::select(Code_sample, Fe),
    # average scat with Fe content >= the 95% quantile
    scat_compo_tib |> 
      dplyr::select(Code_sample, Fe) |>
      dplyr::filter(Fe >= quantile(Fe, 0.95)) |>
      dplyr::summarise(Fe = mean(Fe)) |>
      dplyr::mutate(Code_sample = "highFe_scat") |>
      dplyr::select(Code_sample, Fe)) |>
    dplyr::bind_rows(tibble::tribble(~ "Code_sample", ~ "Fe", 
                                     "median_scat", median_Fe)) |>
    dplyr::left_join(scat_data |>
                       dplyr::filter(Code_sample != "CN12") |>
                       dplyr::select(Code_sample, dw), by = ("Code_sample")) |>
    dplyr::mutate(dw = dplyr::case_when(Code_sample == "median_scat" ~ median_dw, 
                                        Code_sample == "lowFe_scat" ~ below5p_avrg_dw,
                                        Code_sample == "highFe_scat" ~ above95p_avrg_dw),
                  # mass Fe in g is dry mass concentration*dry mass
                  # concentration is in mg.kg-1 dw, so *1e-3 to have it in 
                  # g.kg-1 / dw is in g, so all /1000
                  mFe_g = (Fe*dw*1e-3)/1000, 
                  # mole Fe is m/M with M == 55.845 g.mol-1
                  nFe_mol = mFe_g/55.845, 
                  nFe_micromol = nFe_mol*1e6)
  openxlsx::write.xlsx(scat_Fe_content, 
                       file = paste0("output/table_scats_Fe_moles.xlsx"))
  
  
  # tibble with data on Fe content of the mld in different water mass, 
  # Bowie et al 2015 Biogeosciences
  # there are several sub-stations in each area, so values reported here are 
  # average per area (both for Fe and for mld)
  sea_Fe_Ker <- tibble::tribble(~ "area", ~ "Fe_tot_micromol_ml", ~ "mld", 
                                "offshore_plume", 63, 45, 
                                "plateau", 934, 144) |>
    # if Fe is evenly distributed in the mixed layer, estimate concentration
    # in one cube meter of mixed layer 
    dplyr::mutate(Fe_tot_micromol_1stm3_mld = Fe_tot_micromol_ml/mld)
  
  # calculate relative enrichment of water provoked by one scat release
  # with different possible scat input 
  tib_rel_enrichment <- sea_Fe_Ker |>
    dplyr::bind_cols(scat_Fe_content |> 
                       dplyr::mutate(Code_sample = dplyr::case_when(Fe == max(Fe) ~ "highFe_scat", 
                                                                    Fe == min(Fe) ~ "lowFe_scat", 
                                                                    TRUE ~ Code_sample)) |>
                       dplyr::select(Code_sample, nFe_micromol) |>
                       tidyr::pivot_wider(names_from = Code_sample, 
                                          values_from = nFe_micromol)) |>
    tidyr::pivot_longer(cols = c(`highFe_scat`, `lowFe_scat`, `median_scat`), 
                        names_to = "scat", 
                        values_to = "nFe_micromol_scat") |>
    dplyr::mutate(Fe_rel_enrichment_ml_p = round(100*(nFe_micromol_scat)/Fe_tot_micromol_ml, 
                                                 0),
                  Fe_rel_enrichment_1stm3_p = round(100*(nFe_micromol_scat)/Fe_tot_micromol_1stm3_mld,
                                                    0),
                  Fe_rel_enrichment_ml_p_if_scatFe5pavailable = round(100*(0.05*nFe_micromol_scat)/Fe_tot_micromol_ml, 
                                                                      0),
                  Fe_rel_enrichment_1stm3_p_if_scatFe5pavailable = round(100*(0.05*nFe_micromol_scat)/Fe_tot_micromol_1stm3_mld,
                                                                         0))
  openxlsx::write.xlsx(tib_rel_enrichment, 
                       file = paste0("output/table_Fe_rel_enrichment_around_Ker.xlsx"))
  
  
}

