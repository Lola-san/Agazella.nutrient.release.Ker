################################################################################
# Agazella.modelling.Ker project
# Lola Gilbert lola.gilbert@univ-lr.fr
#
# March 2025
# 04.relative-enrichment-thought-experiment.R
#
################################################################################

# To get a quantitative idea of the relative enrichment 
# in nutrients mediated by fur seals, we compare the Fe input 
# from one hypothetical fur seal scat and the iron pool in the 
# mixed layer, or the Fe regenerated by zooplankton in the mld

# Oceanographic data is from Bowie et al 2015, Iron budgets for three distinct 
# biogeochemical sites around the Kerguelen Archipelago (Southern Ocean) 
# during the natural fertilisation study, KEOPS-2
# in Biogeosciences

#'
#'
#'
#'
#' generate the data on oceanographic conditions at two study stations 
#' (one on Kerguelen Central Plateau and one in an offshore plume east of 
#' Kerguelen) which match relatively well with foraging areas of fur seals 
#' from the two studied colonies (Cap Noir for the offshore plume and 
#' Pointe Suzanne for the Central Plateau)
bowieetal2015_data <- function() {
  # mld, dFe_micromol_perm2, pFe_micromol_perm2 are from Table 1
  # only means are reported for dfe and pFe
  # Fe_mld_regeneration_nmol_perm2_perday is from Table 3
  # bacterial and mesozooplankton regeneration rates
  
  bowie_raw_data <- tibble::tribble(
    ~station, ~substation, ~mld_m, ~dFe_micromol_perm2, ~pFe_micromol_perm2, ~Fe_mld_regeneration_nmol_perm2_perday,
    "Plateau", "A3-1", 165, 54, 1392, 19,
    "Plateau", "A3-2", 123, 21, 401, 71,
    "Plume", "E-1", 64, NA, 117, 27,
    "Plume", "E-3", 32, 12, NA, 23,
    "Plume", "E-5", 39, 2, 61, 31)
  
}


#'
#'
#'
# we need one value per station, so we average data from the substations, per 
# station
wrangling_bowieetal2015_data <- function(bowie_raw) {
  bowie_avg <- bowie_raw |>
    dplyr::group_by(station) |>
    dplyr::summarise(mld_m_avg = mean(mld_m), 
                     dFe_micromol_perm2_avg = mean(dFe_micromol_perm2, 
                                                   na.rm = TRUE),
                     pFe_micromol_perm2_avg = mean(pFe_micromol_perm2, 
                                                   na.rm = TRUE),
                     Fe_mld_regeneration_nmol_perm2_perday_avg = mean(Fe_mld_regeneration_nmol_perm2_perday, 
                                                   na.rm = TRUE))
  
  # for Fe_mld_regeneration rates we want the data in micromole
  # and for all we want also results in m3 (assuming an even distribution across
  # the mld, very simplistically)
  # we also want tFe = dFe +pFe
  
  bowie_complete_clean <- bowie_avg |>
    dplyr::mutate(tFe_micromol_perm2_avg = dFe_micromol_perm2_avg +
                    pFe_micromol_perm2_avg, 
                  dFe_micromol_perm3_avg = dFe_micromol_perm2_avg/mld_m_avg,
                  pFe_micromol_perm3_avg = pFe_micromol_perm2_avg/mld_m_avg, 
                  tFe_micromol_perm3_avg = dFe_micromol_perm3_avg +
                    pFe_micromol_perm3_avg, 
                  Fe_mld_regeneration_micromol_perm2_perday_avg = Fe_mld_regeneration_nmol_perm2_perday_avg*1e-3, 
                  Fe_mld_regeneration_micromol_perm3_perday_avg = Fe_mld_regeneration_micromol_perm2_perday_avg/mld_m_avg) |>
    dplyr::select(station, mld_m_avg,
                  tFe_micromol_perm2_avg, 
                  tFe_micromol_perm3_avg, 
                  Fe_mld_regeneration_micromol_perm2_perday_avg, 
                  Fe_mld_regeneration_micromol_perm3_perday_avg)
  
}


#'
#'
#'
# build up hypothetical scats data
hypo_scats <- function(scat_data,
                       scat_compo_tib) {

  # scats paired by code samples to match dry weights and 
  # Fe concentrations
  scats_paired <- scat_compo_tib |>
    dplyr::select(Code_sample, Fe) |>
    dplyr::left_join(scat_data |>
                       dplyr::select(Code_sample, 
                                     ww, dw), 
                     by = "Code_sample")
  
  # we make the calculations for 3 hypothetical scat: 
  # - one that has low concentrations in Fe, for this one we 
  # filter samples that have Fe concentrations 
  # below the 5 percentile, and we average their concentrations and
  # their dry weight
  # - one with a Fe concentration corresponding to the median value, 
  # we also take the median weigth for this one
  # - one that has high concentrations in Fe, filtering samples that
  # have Fe concentrations above the 95 percentile, and averaging 
  # concentrations and dry weight
  scat_below_5p <- scats_paired |>
    dplyr::filter(Fe <= quantile(Fe, 0.05)) |>
    dplyr::summarise(Fe_mg_kg_avg = mean(Fe), 
                     dw_g_avg = mean(dw)) |>
    dplyr::mutate(scat_type = "below_5p", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
  
  scat_median <- scats_paired |>
    dplyr::summarise(Fe_mg_kg_avg = median(Fe), 
                     dw_g_avg = median(dw)) |>
    dplyr::mutate(scat_type = "median", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
                    
  scat_above_95p <- scats_paired |>
    dplyr::filter(Fe >= quantile(Fe, 0.95)) |>
    dplyr::summarise(Fe_mg_kg_avg = mean(Fe), 
                     dw_g_avg = mean(dw)) |>
    dplyr::mutate(scat_type = "above_95p", 
                  Fe_mg = dw_g_avg*1e-3*Fe_mg_kg_avg, 
                  Fe_mol = Fe_mg*1e-3/55.845,
                  Fe_micromol = Fe_mol*1e6)
    
  # hypo_scat_data 
  hypo_scat_data <- scat_below_5p |>
    dplyr::bind_rows(scat_median, 
                     scat_above_95p) |>
    dplyr::mutate(station = "Plateau") |>
    dplyr::bind_rows(scat_below_5p |>
                       dplyr::mutate(station = "Plume"),
                     scat_median |>
                       dplyr::mutate(station = "Plume"), 
                     scat_above_95p|>
                       dplyr::mutate(station = "Plume")) |>
    dplyr::select(station, scat_type, 
                  dw_g_avg, Fe_mg_kg_avg, 
                  Fe_mg, Fe_micromol)
}

#'
#'
#'
#'
# compute relative enrichment %
relative_enrichment <- function(bowie_clean_data, 
                                hypo_scat_data) {

  rel_enrichment_p <- bowie_clean_data |>
    dplyr::left_join(hypo_scat_data, 
                     by = "station") |>
    dplyr::mutate(rel_Fe_enrichment_perm2 = 100*(Fe_micromol/tFe_micromol_perm2_avg), 
                  rel_Fe_enrichment_perm3 = 100*(Fe_micromol/tFe_micromol_perm3_avg), 
                  rel_Fe_enrichment_perm2_5p = 100*(0.05*Fe_micromol/tFe_micromol_perm2_avg), 
                  rel_Fe_enrichment_perm3_5p = 100*(0.05*Fe_micromol/tFe_micromol_perm3_avg))
  
  openxlsx::write.xlsx(rel_enrichment_p, 
                       file = paste0("output/figures-tables-article/table_Fe_rel_enrichment_around_Ker.xlsx"))
}


